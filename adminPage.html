<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>管理画面 - 勤怠管理システム</title>
  <?!= include('css'); ?>
  <style>
    .admin-container {
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #eaeaea;
      margin-bottom: 2rem;
    }
    
    .tab-button {
      padding: 1rem 2rem;
      background-color: #f8f9fa;
      border: 1px solid #eaeaea;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      margin-right: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      color: #777;
    }
    
    .tab-button.active {
      background-color: white;
      color: #4b6cb7;
      border-bottom: 2px solid #4b6cb7;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .table-container {
      overflow-x: auto;
      margin-bottom: 2rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #eaeaea;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    
    tr:hover {
      background-color: #f0f4ff;
    }
    
    .action-column {
      text-align: right;
      white-space: nowrap;
    }
    
    .action-button {
      padding: 0.4rem 0.75rem;
      background-color: #4b6cb7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }
    
    .delete-button {
      background-color: #f44336;
    }
    
    .form-section {
      background-color: white;
      border: 1px solid #eaeaea;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-section h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #333;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .export-section {
      background-color: #f8f9fa;
      border: 1px solid #eaeaea;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .date-range {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .date-input {
      width: 150px;
    }
    
    .export-button {
      background-color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>管理画面</h1>
      </div>
      <div class="header-right">
        <div id="current-datetime"></div>
        <a href="<?= ScriptApp.getService().getUrl() ?>" target="_top" id="back-to-main" class="admin-button">メイン画面に戻る</a>
      </div>
    </header>
    
    <div class="admin-container">
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="employees">社員管理</button>
        <button class="tab-button" data-tab="work-items">作業項目管理</button>
        <button class="tab-button" data-tab="export">データ出力</button>
      </div>
      
      <!-- 社員管理タブ -->
      <div id="employees-tab" class="tab-content active">
        <div class="form-section">
          <h3>社員の追加</h3>
          <div class="form-row">
            <div class="form-column">
              <div class="form-group">
                <label for="new-employee-id">社員ID</label>
                <input type="text" id="new-employee-id" placeholder="例: E001">
              </div>
            </div>
            <div class="form-column">
              <div class="form-group">
                <label for="new-employee-name">社員名</label>
                <input type="text" id="new-employee-name" placeholder="例: 山田太郎">
              </div>
            </div>
          </div>
          <button id="add-employee" class="btn primary">社員を追加</button>
        </div>
        
        <div class="table-container">
          <h3>社員一覧</h3>
          <table id="employees-table">
            <thead>
              <tr>
                <th>社員ID</th>
                <th>社員名</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <!-- ここに社員リストが動的に生成されます -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 作業項目管理タブ -->
      <div id="work-items-tab" class="tab-content">
        <div class="form-section">
          <h3>作業項目の追加</h3>
          <div class="form-row">
            <div class="form-column">
              <div class="form-group">
                <label for="new-work-item-id">作業ID</label>
                <input type="text" id="new-work-item-id" placeholder="例: W001">
              </div>
            </div>
            <div class="form-column">
              <div class="form-group">
                <label for="new-work-item-name">作業名</label>
                <input type="text" id="new-work-item-name" placeholder="例: 溶接">
              </div>
            </div>
          </div>
          <button id="add-work-item" class="btn primary">作業項目を追加</button>
        </div>
        
        <div class="table-container">
          <h3>作業項目一覧</h3>
          <table id="work-items-table">
            <thead>
              <tr>
                <th>作業ID</th>
                <th>作業名</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <!-- ここに作業項目リストが動的に生成されます -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- データ出力タブ -->
      <div id="export-tab" class="tab-content">
        <div class="export-section">
          <h3>勤怠データの出力</h3>
          <div class="date-range">
            <label for="attendance-start-date">開始日:</label>
            <input type="date" id="attendance-start-date" class="date-input">
            <label for="attendance-end-date">終了日:</label>
            <input type="date" id="attendance-end-date" class="date-input">
          </div>
          <button id="export-attendance" class="btn export-button">勤怠データをExcelで出力</button>
        </div>
        
        <div class="export-section">
          <h3>作業記録の出力</h3>
          <div class="date-range">
            <label for="work-record-start-date">開始日:</label>
            <input type="date" id="work-record-start-date" class="date-input">
            <label for="work-record-end-date">終了日:</label>
            <input type="date" id="work-record-end-date" class="date-input">
          </div>
          <button id="export-work-records" class="btn export-button">作業記録をExcelで出力</button>
        </div>
      </div>
    </div>
    
    <footer>
      <p>© 2025 勤怠管理システム</p>
    </footer>
  </div>
  
  <!-- 確認モーダル -->
  <div id="confirm-modal" class="modal-container hidden">
    <div class="modal-content">
      <div id="modal-header">
        <h3 id="confirm-title">確認</h3>
        <span class="close-modal" onclick="closeConfirmModal()">&times;</span>
      </div>
      <div id="confirm-body">
        <p id="confirm-message"></p>
      </div>
      <div id="modal-footer">
        <button id="cancel-action" class="btn secondary" onclick="closeConfirmModal()">キャンセル</button>
        <button id="confirm-action" class="btn primary" onclick="executeCurrentAction()">確認</button>
      </div>
    </div>
  </div>
  
  <script>
    // グローバル変数
    let employees = [];
    let workItems = [];
    let currentAction = null;
    let targetId = null;
    
    // 初期化処理
    function initializeAdminPage() {
      console.log('管理画面の初期化を開始します');
      
      // 時間表示の更新
      updateDateTime();
      setInterval(updateDateTime, 1000); // 1秒ごとに時間を更新
      
      // 社員データの取得
      fetchEmployees();
      
      // 作業項目データの取得
      fetchWorkItems();
      
      // 日付フィールドの初期値設定
      setDefaultDates();
      
      // タブ切り替えのイベントリスナーを設定
      setupTabEventListeners();
      
      console.log('管理画面の初期化が完了しました');
    }
    
    // ページ読み込み後に初期化を実行
    window.onload = function() {
      console.log('Windowの読み込みが完了しました');
      initializeAdminPage();
    };
    
    // 日時の更新
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      const dateTimeStr = now.toLocaleDateString('ja-JP', options);
      document.getElementById('current-datetime').textContent = dateTimeStr;
    }
    
    // 社員一覧の取得
    function fetchEmployees() {
      console.log('社員データを取得中...');
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('社員データを取得しました:', data);
          employees = data || [];
          renderEmployeesTable();
          
          // データが空の場合は再試行
          if (!data || data.length === 0) {
            console.log('社員データが空です。再試行します...');
            setTimeout(function() {
              google.script.run
                .withSuccessHandler(function(retryData) {
                  console.log('再試行で社員データを取得しました:', retryData);
                  employees = retryData || [];
                  renderEmployeesTable();
                })
                .getEmployees();
            }, 1000);
          }
        })
        .withFailureHandler(function(error) {
          console.error('社員データの取得に失敗しました:', error);
          employees = [];
          renderEmployeesTable();
        })
        .getEmployees();
    }
    
    // 作業項目一覧の取得
    function fetchWorkItems() {
      console.log('作業項目データを取得中...');
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('作業項目データを取得しました:', data);
          workItems = data || [];
          renderWorkItemsTable();
          
          // データが空の場合は再試行
          if (!data || data.length === 0) {
            console.log('作業項目データが空です。再試行します...');
            setTimeout(function() {
              google.script.run
                .withSuccessHandler(function(retryData) {
                  console.log('再試行で作業項目データを取得しました:', retryData);
                  workItems = retryData || [];
                  renderWorkItemsTable();
                })
                .getWorkItems();
            }, 1000);
          }
        })
        .withFailureHandler(function(error) {
          console.error('作業項目データの取得に失敗しました:', error);
          workItems = [];
          renderWorkItemsTable();
        })
        .getWorkItems();
    }
    
    // 社員テーブルの表示
    function renderEmployeesTable() {
      try {
        console.log('社員テーブルを描画します。社員数:', employees ? employees.length : 0);
        
        const tableBody = document.querySelector('#employees-table tbody');
        if (!tableBody) {
          console.error('#employees-table tbody 要素が見つかりません');
          return;
        }
        
        // テーブルをクリア
        tableBody.innerHTML = '';
        
        // 社員データが空の場合のメッセージ
        if (!employees || employees.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="3" style="text-align: center;">社員データがありません</td>';
          tableBody.appendChild(emptyRow);
          return;
        }
        
        // 各社員の行を作成
        employees.forEach(function(employee) {
          const row = document.createElement('tr');
          
          // 編集ボタンのクリックイベントを直接設定
          const editBtnId = 'edit-employee-' + employee.id;
          const deleteBtnId = 'delete-employee-' + employee.id;
          
          row.innerHTML = `
            <td>${employee.id}</td>
            <td>${employee.name}</td>
            <td class="action-column">
              <button id="${editBtnId}" class="action-button edit-employee">編集</button>
              <button id="${deleteBtnId}" class="action-button delete-button delete-employee">削除</button>
            </td>
          `;
          
          tableBody.appendChild(row);
          
          // DOMが描画された後にイベントリスナーを設定
          setTimeout(function() {
            const editBtn = document.getElementById(editBtnId);
            if (editBtn) {
              editBtn.onclick = function() {
                console.log('編集ボタンがクリックされました:', employee.id);
                editEmployee(employee.id);
              };
            }
            
            const deleteBtn = document.getElementById(deleteBtnId);
            if (deleteBtn) {
              deleteBtn.onclick = function() {
                console.log('削除ボタンがクリックされました:', employee.id);
                confirmDeleteEmployee(employee.id);
              };
            }
          }, 0);
        });
        
        console.log('社員テーブルの描画が完了しました');
      } catch (error) {
        console.error('社員テーブルの描画中にエラーが発生しました:', error);
      }
    }
    
    // 作業項目テーブルの表示
    function renderWorkItemsTable() {
      try {
        console.log('作業項目テーブルを描画します。項目数:', workItems ? workItems.length : 0);
        
        const tableBody = document.querySelector('#work-items-table tbody');
        if (!tableBody) {
          console.error('#work-items-table tbody 要素が見つかりません');
          return;
        }
        
        // テーブルをクリア
        tableBody.innerHTML = '';
        
        // 作業項目データが空の場合のメッセージ
        if (!workItems || workItems.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="3" style="text-align: center;">作業項目データがありません</td>';
          tableBody.appendChild(emptyRow);
          return;
        }
        
        // 各作業項目の行を作成
        workItems.forEach(function(item) {
          const row = document.createElement('tr');
          
          // 編集ボタンのクリックイベントを直接設定
          const editBtnId = 'edit-work-item-' + item.id;
          const deleteBtnId = 'delete-work-item-' + item.id;
          
          row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td class="action-column">
              <button id="${editBtnId}" class="action-button edit-work-item">編集</button>
              <button id="${deleteBtnId}" class="action-button delete-button delete-work-item">削除</button>
            </td>
          `;
          
          tableBody.appendChild(row);
          
          // DOMが描画された後にイベントリスナーを設定
          setTimeout(function() {
            const editBtn = document.getElementById(editBtnId);
            if (editBtn) {
              editBtn.onclick = function() {
                console.log('編集ボタンがクリックされました:', item.id);
                editWorkItem(item.id);
              };
            }
            
            const deleteBtn = document.getElementById(deleteBtnId);
            if (deleteBtn) {
              deleteBtn.onclick = function() {
                console.log('削除ボタンがクリックされました:', item.id);
                confirmDeleteWorkItem(item.id);
              };
            }
          }, 0);
        });
        
        console.log('作業項目テーブルの描画が完了しました');
      } catch (error) {
        console.error('作業項目テーブルの描画中にエラーが発生しました:', error);
      }
    }
    
    // 日付フィールドの初期値設定
    function setDefaultDates() {
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      const formatDate = date => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      document.getElementById('attendance-start-date').value = formatDate(firstDayOfMonth);
      document.getElementById('attendance-end-date').value = formatDate(lastDayOfMonth);
      document.getElementById('work-record-start-date').value = formatDate(firstDayOfMonth);
      document.getElementById('work-record-end-date').value = formatDate(lastDayOfMonth);
    }
    
    // タブ切り替えのイベントリスナー設定
    function setupTabEventListeners() {
      console.log('タブ切り替えのイベントリスナーを設定します');
      
      // 各タブボタンにクリックイベントを設定
      const employeesTabButton = document.querySelector('.tab-button[data-tab="employees"]');
      const workItemsTabButton = document.querySelector('.tab-button[data-tab="work-items"]');
      const exportTabButton = document.querySelector('.tab-button[data-tab="export"]');
      
      if (employeesTabButton) {
        employeesTabButton.onclick = function() {
          switchTab('employees');
        };
      }
      
      if (workItemsTabButton) {
        workItemsTabButton.onclick = function() {
          switchTab('work-items');
        };
      }
      
      if (exportTabButton) {
        exportTabButton.onclick = function() {
          switchTab('export');
        };
      }
      
      // 社員追加ボタン
      const addEmployeeButton = document.getElementById('add-employee');
      if (addEmployeeButton) {
        addEmployeeButton.onclick = function() {
          addEmployee();
        };
      }
      
      // 作業項目追加ボタン
      const addWorkItemButton = document.getElementById('add-work-item');
      if (addWorkItemButton) {
        addWorkItemButton.onclick = function() {
          addWorkItem();
        };
      }
      
      // 勤怠データ出力ボタン
      const exportAttendanceButton = document.getElementById('export-attendance');
      if (exportAttendanceButton) {
        exportAttendanceButton.onclick = function() {
          exportAttendanceData();
        };
      }
      
      // 作業記録出力ボタン
      const exportWorkRecordsButton = document.getElementById('export-work-records');
      if (exportWorkRecordsButton) {
        exportWorkRecordsButton.onclick = function() {
          exportWorkRecords();
        };
      }
      
      console.log('タブ切り替えのイベントリスナー設定完了');
    }
    
    // タブ切り替え関数
    function switchTab(tabId) {
      console.log('タブ切り替え:', tabId);
      
      // タブボタンのアクティブ状態を切り替え
      document.querySelectorAll('.tab-button').forEach(function(tab) {
        tab.classList.remove('active');
      });
      document.querySelector('.tab-button[data-tab="' + tabId + '"]').classList.add('active');
      
      // タブコンテンツの表示を切り替え
      document.querySelectorAll('.tab-content').forEach(function(content) {
        content.classList.remove('active');
      });
      document.getElementById(tabId + '-tab').classList.add('active');
    }
    
    // 社員の追加
    function addEmployee() {
      console.log('社員追加処理を開始します');
      
      // 入力値を取得
      const id = document.getElementById('new-employee-id').value.trim();
      const name = document.getElementById('new-employee-name').value.trim();
      
      // 入力チェック
      if (!id || !name) {
        alert('社員IDと社員名を入力してください');
        return;
      }
      
      // 重複チェック
      if (employees.some(emp => emp.id === id)) {
        alert('その社員IDはすでに使用されています');
        return;
      }
      
      // 処理中のメッセージを表示
      const loadingMsg = document.createElement('div');
      loadingMsg.id = 'loading-message';
      loadingMsg.style.position = 'fixed';
      loadingMsg.style.top = '50%';
      loadingMsg.style.left = '50%';
      loadingMsg.style.transform = 'translate(-50%, -50%)';
      loadingMsg.style.padding = '20px';
      loadingMsg.style.background = 'rgba(0,0,0,0.7)';
      loadingMsg.style.color = 'white';
      loadingMsg.style.borderRadius = '5px';
      loadingMsg.style.zIndex = '9999';
      loadingMsg.textContent = '社員を追加中...';
      document.body.appendChild(loadingMsg);
      
      // サーバーに追加リクエストを送信
      console.log('サーバーに社員追加リクエストを送信します:', id, name);
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('社員追加成功:', result);
          
          // ローディングメッセージを削除
          if (document.getElementById('loading-message')) {
            document.body.removeChild(document.getElementById('loading-message'));
          }
          
          // 成功メッセージを表示
          alert('社員を追加しました');
          
          // 入力フィールドをクリア
          document.getElementById('new-employee-id').value = '';
          document.getElementById('new-employee-name').value = '';
          
          // 新しい社員をメモリに追加
          employees.push({
            id: id,
            name: name
          });
          
          // テーブルを再描画
          renderEmployeesTable();
          
          // サーバーから最新データを再取得
          setTimeout(function() {
            fetchEmployees();
          }, 1000);
        })
        .withFailureHandler(function(error) {
          console.error('社員追加エラー:', error);
          
          // ローディングメッセージを削除
          if (document.getElementById('loading-message')) {
            document.body.removeChild(document.getElementById('loading-message'));
          }
          
          // エラーメッセージを表示
          alert('社員の追加に失敗しました: ' + error);
        })
        .addEmployee(id, name);
    }
    
    // 社員の編集
    function editEmployee(employeeId) {
      const employee = employees.find(emp => emp.id === employeeId);
      if (!employee) return;
      
      const newName = prompt('新しい社員名を入力してください', employee.name);
      if (newName === null) return; // キャンセルされた場合
      
      if (newName.trim() === '') {
        alert('社員名を入力してください');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('社員情報を更新しました');
          fetchEmployees(); // 一覧を更新
        })
        .withFailureHandler(function(error) {
          alert('社員情報の更新に失敗しました: ' + error);
        })
        .updateEmployee(employeeId, newName);
    }
    
    // 社員削除の確認
    function confirmDeleteEmployee(employeeId) {
      try {
        console.log('社員削除の確認モーダルを表示します:', employeeId);
        
        // 社員情報を取得
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee) {
          console.error('指定された社員IDが見つかりません:', employeeId);
          alert('指定された社員が見つかりません');
          return;
        }
        
        // 確認モーダルの設定
        currentAction = 'deleteEmployee';
        targetId = employeeId;
        
        // モーダルのタイトルとメッセージを設定
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmModal = document.getElementById('confirm-modal');
        
        if (!confirmTitle || !confirmMessage || !confirmModal) {
          console.error('確認モーダルの要素が見つかりません');
          return;
        }
        
        confirmTitle.textContent = '社員の削除';
        confirmMessage.textContent = `社員「${employee.name}」を削除します。この操作は取り消せません。続行しますか？`;
        
        // 確認ボタンに直接イベントを設定
        const confirmActionBtn = document.getElementById('confirm-action');
        if (confirmActionBtn) {
          confirmActionBtn.onclick = function() {
            console.log('削除確認ボタンがクリックされました:', employeeId);
            closeConfirmModal();
            deleteEmployee(employeeId);
          };
        }
        
        // モーダルを表示
        confirmModal.classList.remove('hidden');
        console.log('確認モーダルを表示しました');
      } catch (error) {
        console.error('確認モーダル表示中にエラーが発生しました:', error);
        alert('エラーが発生しました: ' + error.message);
      }
    }
    
    // 社員の削除
    function deleteEmployee(employeeId) {
      try {
        console.log('社員を削除します:', employeeId);
        
        // 削除対象の社員を確認
        const employeeToDelete = employees.find(emp => emp.id === employeeId);
        if (!employeeToDelete) {
          console.error('削除対象の社員が見つかりません:', employeeId);
          alert('指定された社員が見つかりません');
          return;
        }
        
        // 削除処理中のメッセージを表示
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-message';
        loadingMsg.style.position = 'fixed';
        loadingMsg.style.top = '50%';
        loadingMsg.style.left = '50%';
        loadingMsg.style.transform = 'translate(-50%, -50%)';
        loadingMsg.style.padding = '20px';
        loadingMsg.style.background = 'rgba(0,0,0,0.7)';
        loadingMsg.style.color = 'white';
        loadingMsg.style.borderRadius = '5px';
        loadingMsg.style.zIndex = '9999';
        loadingMsg.textContent = '社員を削除中...';
        document.body.appendChild(loadingMsg);
        
        // メモリ上で先に削除してUIを更新
        employees = employees.filter(emp => emp.id !== employeeId);
        renderEmployeesTable();
        
        // サーバーに削除リクエストを送信
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('社員削除成功:', result);
            
            // ローディングメッセージを削除
            if (document.getElementById('loading-message')) {
              document.body.removeChild(document.getElementById('loading-message'));
            }
            
            alert('社員を削除しました');
            
            // サーバーから最新データを取得して確実に反映
            setTimeout(function() {
              console.log('社員一覧を再取得します...');
              google.script.run
                .withSuccessHandler(function(data) {
                  console.log('社員一覧を再取得しました:', data);
                  employees = data || [];
                  renderEmployeesTable();
                  
                  // 削除が成功したか確認
                  const stillExists = employees.some(emp => emp.id === employeeId);
                  if (stillExists) {
                    console.warn('警告: 削除後も社員IDが存在しています:', employeeId);
                    alert('警告: 削除処理が完全に反映されていない可能性があります。再度お試しください。');
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('社員一覧の再取得に失敗しました:', error);
                })
                .getEmployees();
            }, 1000);
          })
          .withFailureHandler(function(error) {
            console.error('社員削除エラー:', error);
            
            // ローディングメッセージを削除
            if (document.getElementById('loading-message')) {
              document.body.removeChild(document.getElementById('loading-message'));
            }
            
            // エラー時は元のデータを再取得して表示を元に戻す
            alert('社員の削除に失敗しました: ' + error);
            google.script.run
              .withSuccessHandler(function(data) {
                employees = data || [];
                renderEmployeesTable();
              })
              .getEmployees();
          })
          .deleteEmployee(employeeId);
      } catch (error) {
        console.error('社員削除処理中にエラーが発生しました:', error);
        alert('エラーが発生しました: ' + error.message);
      }
    }
    
    // 作業項目の追加
    function addWorkItem() {
      const id = document.getElementById('new-work-item-id').value.trim();
      const name = document.getElementById('new-work-item-name').value.trim();
      
      if (!id || !name) {
        alert('作業IDと作業名を入力してください');
        return;
      }
      
      // 重複チェック
      if (workItems.some(item => item.id === id)) {
        alert('その作業IDはすでに使用されています');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('作業項目を追加しました');
          document.getElementById('new-work-item-id').value = '';
          document.getElementById('new-work-item-name').value = '';
          fetchWorkItems(); // 一覧を更新
        })
        .withFailureHandler(function(error) {
          alert('作業項目の追加に失敗しました: ' + error);
        })
        .addWorkItem(id, name);
    }
    
    // 作業項目の編集
    function editWorkItem(itemId) {
      const item = workItems.find(item => item.id === itemId);
      if (!item) return;
      
      const newName = prompt('新しい作業名を入力してください', item.name);
      if (newName === null) return; // キャンセルされた場合
      
      if (newName.trim() === '') {
        alert('作業名を入力してください');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          alert('作業項目を更新しました');
          fetchWorkItems(); // 一覧を更新
        })
        .withFailureHandler(function(error) {
          alert('作業項目の更新に失敗しました: ' + error);
        })
        .updateWorkItem(itemId, newName);
    }
    
    // 作業項目削除の確認
    function confirmDeleteWorkItem(itemId) {
      const item = workItems.find(item => item.id === itemId);
      if (!item) return;
      
      currentAction = 'deleteWorkItem';
      targetId = itemId;
      
      document.getElementById('confirm-title').textContent = '作業項目の削除';
      document.getElementById('confirm-message').textContent = 
        `作業項目「${item.name}」を削除します。この操作は取り消せません。続行しますか？`;
      
      document.getElementById('confirm-modal').classList.remove('hidden');
    }
    
    // 作業項目の削除
    function deleteWorkItem(itemId) {
      google.script.run
        .withSuccessHandler(function(result) {
          alert('作業項目を削除しました');
          fetchWorkItems(); // 一覧を更新
        })
        .withFailureHandler(function(error) {
          alert('作業項目の削除に失敗しました: ' + error);
        })
        .deleteWorkItem(itemId);
    }
    
    // 勤怠データの出力
    function exportAttendanceData() {
      const startDate = document.getElementById('attendance-start-date').value;
      const endDate = document.getElementById('attendance-end-date').value;
      
      if (!startDate || !endDate) {
        alert('開始日と終了日を入力してください');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(fileUrl) {
          if (fileUrl) {
            alert('勤怠データをExcelで出力しました');
            window.open(fileUrl, '_blank');
          } else {
            alert('該当するデータがありませんでした');
          }
        })
        .withFailureHandler(function(error) {
          alert('出力に失敗しました: ' + error);
        })
        .exportAttendanceData(startDate, endDate);
    }
    
    // 作業記録の出力
    function exportWorkRecords() {
      const startDate = document.getElementById('work-record-start-date').value;
      const endDate = document.getElementById('work-record-end-date').value;
      
      if (!startDate || !endDate) {
        alert('開始日と終了日を入力してください');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(fileUrl) {
          if (fileUrl) {
            alert('作業記録をExcelで出力しました');
            window.open(fileUrl, '_blank');
          } else {
            alert('該当するデータがありませんでした');
          }
        })
        .withFailureHandler(function(error) {
          alert('出力に失敗しました: ' + error);
        })
        .exportWorkRecords(startDate, endDate);
    }
    
    // 確認モーダルを閉じる
    function closeConfirmModal() {
      console.log('確認モーダルを閉じます');
      document.getElementById('confirm-modal').classList.add('hidden');
      currentAction = null;
      targetId = null;
    }
    
    // 現在の操作を実行
    function executeCurrentAction() {
      console.log('操作を実行します:', currentAction, targetId);
      if (currentAction === 'deleteEmployee') {
        deleteEmployee(targetId);
      } else if (currentAction === 'deleteWorkItem') {
        deleteWorkItem(targetId);
      }
      
      closeConfirmModal();
    }
    
    // メイン画面に戻るリンクは直接URLを指定しているのでこの関数は不要
    // function returnToMainPage() {
    //   // メインページに直接遷移する
    //   window.location.href = window.location.href.replace('?page=admin', '');
    // }
  </script>
</body>
</html>
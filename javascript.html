<script>
    // グローバル変数
    let employees = []; // 社員データ
    let selectedEmployeeId = null; // 選択中の社員ID
    
    // 初期化処理
    function initializeMainPage() {
      console.log('メイン画面の初期化を開始します');
      
      // 日時の更新
      updateDateTime();
      setInterval(updateDateTime, 1000); // 1秒ごとに時間を更新
      
      // 社員一覧の取得
      fetchEmployees();
      
      // イベントリスナーの設定
      setupEventListeners();
      
      console.log('メイン画面の初期化が完了しました');
    }
    
    // ページ読み込み完了時に初期化を実行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMの読み込みが完了しました');
      initializeMainPage();
    });
    
    // window.onloadも定義しておく（冗長化で確実に処理を実行）
    window.onload = function() {
      console.log('window.onloadが実行されました');
      
      // 社員データが取得されていない場合は再取得
      if (!employees || employees.length === 0) {
        console.log('社員データが取得されていないため再取得します');
        initializeMainPage();
      }
    };
    
    // 日時の更新
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      const dateTimeStr = now.toLocaleDateString('ja-JP', options);
      document.getElementById('current-datetime').textContent = dateTimeStr;
    }
    
    // 社員一覧の取得 - 管理画面と完全に同じ方法
    function fetchEmployees() {
      console.log('社員データを取得中...');
      
      // ローディング表示
      const employeeList = document.getElementById('employee-list');
      if (employeeList) {
        employeeList.innerHTML = '<div class="loading-message">社員データを読み込み中...</div>';
      }
      
      // デバッグ用に直接データを設定
      const debugData = [
        { id: '1', name: '山田太郎' },
        { id: '2', name: '鈴木花子' },
        { id: '3', name: '田中三郎' }
      ];
      
      // サーバーからデータを取得
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('社員データを取得しました:', data);
          
          // データが空の場合はデバッグデータを使用
          if (!data || data.length === 0) {
            console.log('取得したデータが空のためデバッグデータを使用します');
            employees = debugData;
          } else {
            employees = data;
          }
          
          // 社員一覧を表示
          renderEmployeeList();
          
          // データが空の場合は再試行
          if (!data || data.length === 0) {
            console.log('社員データが空です。再試行します...');
            setTimeout(function() {
              google.script.run
                .withSuccessHandler(function(retryData) {
                  console.log('再試行で社員データを取得しました:', retryData);
                  if (retryData && retryData.length > 0) {
                    employees = retryData;
                    renderEmployeeList();
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('再試行時のエラー:', error);
                })
                .getEmployees();
            }, 1000);
          }
        })
        .withFailureHandler(function(error) {
          console.error('社員データの取得に失敗しました:', error);
          // エラー時はデバッグデータを使用
          employees = debugData;
          renderEmployeeList();
        })
        .getEmployees();
    }
    
    // 社員一覧の表示 - シンプルなスクロール可能な一覧表示
    function renderEmployeeList() {
      try {
        console.log('社員一覧を表示します。社員数:', employees ? employees.length : 0);
        
        // 社員リスト要素を取得
        const employeeListElement = document.getElementById('employee-list');
        if (!employeeListElement) {
          console.error('employee-list要素が見つかりません');
          return;
        }
        
        // リストをクリア
        employeeListElement.innerHTML = '';
        
        // スクロール可能なスタイルを追加
        employeeListElement.style.maxHeight = '400px';
        employeeListElement.style.overflowY = 'auto';
        employeeListElement.style.border = '1px solid #ddd';
        employeeListElement.style.borderRadius = '4px';
        employeeListElement.style.padding = '8px';
        
        // 社員データが空の場合のメッセージ
        if (!employees || employees.length === 0) {
          employeeListElement.innerHTML = '<div class="empty-message">社員データがありません</div>';
          return;
        }
        
        // 各社員の要素を作成
        let html = '';
        employees.forEach(function(employee) {
          if (!employee || !employee.id || !employee.name) return;
          
          const selectedClass = (employee.id === selectedEmployeeId) ? ' selected' : '';
          html += `<div class="employee-item${selectedClass}" data-id="${employee.id}" onclick="selectEmployee('${employee.id}')">${employee.name}</div>`;
        });
        
        // HTMLを設定
        employeeListElement.innerHTML = html;
        
        // 表示された社員数を確認
        const displayedCount = document.querySelectorAll('.employee-item').length;
        console.log('表示された社員数:', displayedCount);
        
        // 表示された社員が0件の場合はメッセージを表示
        if (displayedCount === 0) {
          employeeListElement.innerHTML = '<div class="warning-message">表示可能な社員がありません。管理画面から社員を追加してください。</div>';
        }
        
        // デバッグ用に表示された社員の詳細をログ出力
        console.log('表示された社員データ:', employees);
      } catch (error) {
        console.error('社員一覧の表示中にエラーが発生しました:', error);
      }
    }
    
    // 社員の選択 - シンプル版
    function selectEmployee(employeeId) {
      try {
        console.log('社員を選択します:', employeeId);
        
        // 選択した社員IDを保存
        selectedEmployeeId = employeeId;
        
        // 全ての社員要素からselectedクラスを削除
        document.querySelectorAll('.employee-item').forEach(function(item) {
          item.classList.remove('selected');
        });
        
        // 選択された社員にクラスを追加
        const selectedItem = document.querySelector(`.employee-item[data-id="${employeeId}"]`);
        if (selectedItem) {
          selectedItem.classList.add('selected');
        }
        
        // 選択した社員の情報を表示
        const employee = employees.find(emp => emp.id === employeeId);
        if (employee) {
          console.log('選択された社員情報:', employee);
          
          // 社員名を表示
          const nameElement = document.getElementById('selected-employee-name');
          if (nameElement) {
            nameElement.textContent = employee.name;
          } else {
            console.error('selected-employee-name要素が見つかりません');
          }
          
          // パネルの表示切替
          const noSelection = document.getElementById('no-selection');
          const attendanceActions = document.getElementById('attendance-actions');
          
          if (noSelection) {
            noSelection.classList.add('hidden');
          } else {
            console.error('no-selection要素が見つかりません');
          }
          
          if (attendanceActions) {
            attendanceActions.classList.remove('hidden');
          } else {
            console.error('attendance-actions要素が見つかりません');
          }
        } else {
          console.error('選択された社員が見つかりません:', employeeId);
        }
        
        // ステータスメッセージをクリア
        clearStatusMessage();
      } catch (error) {
        console.error('社員選択処理中にエラーが発生しました:', error);
      }
    }
    
    // イベントリスナーの設定
    function setupEventListeners() {
      // 出勤ボタン
      document.getElementById('check-in-btn').addEventListener('click', function() {
        showTimeConfirmation('出勤', function(time) {
          recordAttendance('check-in', time);
        });
      });
      
      // 退勤ボタン
      document.getElementById('check-out-btn').addEventListener('click', function() {
        showTimeConfirmation('退勤', function(time) {
          recordAttendance('check-out', time);
        });
      });
      
      // 管理者リンク
      document.getElementById('admin-link').addEventListener('click', function(e) {
        e.preventDefault();
        showPasswordModal();
      });
      
      // 社員検索
      document.getElementById('employee-search').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredEmployees = employees.filter(emp => 
          emp.name.toLowerCase().includes(searchTerm)
        );
        renderEmployeeList(filteredEmployees);
      });
      
      // モーダルを閉じるボタン
      document.querySelectorAll('.close-modal').forEach(function(btn) {
        btn.addEventListener('click', closeAllModals);
      });
      
      // パスワードモーダルのキャンセルボタン
      document.getElementById('cancel-password').addEventListener('click', closeAllModals);
      
      // パスワード送信ボタン
      document.getElementById('submit-password').addEventListener('click', validateAdminPassword);
    }
    
    // 時間確認モーダルの表示
    function showTimeConfirmation(actionType, callback) {
      if (!selectedEmployeeId) {
        showError("社員を選択してください");
        return;
      }
      
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const title = actionType === '出勤' ? '出勤時間の確認' : '退勤時間の確認';
      const employee = employees.find(emp => emp.id === selectedEmployeeId);
      
      // モーダル内容を設定
      document.getElementById('modal-title').textContent = title;
      
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <p>${employee.name}さんの${actionType}時間を登録します：</p>
        <div class="time-display">${timeStr}</div>
        <p>この時間で登録しますか？</p>
      `;
      
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button id="cancel-action" class="btn secondary">キャンセル</button>
        <button id="confirm-action" class="btn primary">OK</button>
      `;
      
      // ボタンにイベントを設定
      document.getElementById('cancel-action').addEventListener('click', closeAllModals);
      document.getElementById('confirm-action').addEventListener('click', function() {
        closeAllModals();
        callback(now);
      });
      
      // モーダルを表示
      document.getElementById('modal-container').classList.remove('hidden');
    }
    
    // 出退勤の記録
    function recordAttendance(type, time) {
      const employee = employees.find(emp => emp.id === selectedEmployeeId);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (type === 'check-in') {
            showSuccess(`${employee.name}さんの出勤を記録しました。`);
          } else {
            showSuccess(`${employee.name}さんの退勤を記録しました。`);
            // 作業記録の確認
            setTimeout(function() {
              askForWorkRecord();
            }, 1500);
          }
        })
        .withFailureHandler(function(error) {
          showError("記録に失敗しました: " + error);
        })
        .recordAttendance(selectedEmployeeId, type, time.toISOString());
    }
    
    // 作業記録の確認
    function askForWorkRecord() {
      const employee = employees.find(emp => emp.id === selectedEmployeeId);
      
      // モーダル内容を設定
      document.getElementById('modal-title').textContent = '作業記録の確認';
      
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <p>${employee.name}さん、本日の作業記録はありますか？</p>
      `;
      
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button id="no-work-record" class="btn secondary">いいえ</button>
        <button id="yes-work-record" class="btn primary">はい</button>
      `;
      
      // ボタンにイベントを設定
      document.getElementById('no-work-record').addEventListener('click', function() {
        closeAllModals();
        showThankYouMessage();
      });
      
      document.getElementById('yes-work-record').addEventListener('click', function() {
        closeAllModals();
        showWorkRecordForm();
      });
      
      // モーダルを表示
      document.getElementById('modal-container').classList.remove('hidden');
    }
    
    // お疲れ様メッセージの表示
    function showThankYouMessage() {
      const employee = employees.find(emp => emp.id === selectedEmployeeId);
      
      // モーダル内容を設定
      document.getElementById('modal-title').textContent = 'お疲れ様でした';
      
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <p>${employee.name}さん、本日もお疲れ様でした！</p>
      `;
      
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button id="close-thank-you" class="btn primary">閉じる</button>
      `;
      
      // ボタンにイベントを設定
      document.getElementById('close-thank-you').addEventListener('click', function() {
        closeAllModals();
        resetSelection();
      });
      
      // モーダルを表示
      document.getElementById('modal-container').classList.remove('hidden');
    }
    
    // 作業記録フォームの表示
    function showWorkRecordForm() {
      // 作業項目の取得
      google.script.run
        .withSuccessHandler(function(workItems) {
          const employee = employees.find(emp => emp.id === selectedEmployeeId);
          
          // 新しいページに遷移
          google.script.run.withSuccessHandler(function(html) {
            // 現在のページを新しいHTMLで置き換える
            document.open();
            document.write(html);
            document.close();
            
            // JavaScriptがリロードされるため、親ページから値を渡す必要があるものは
            // URLパラメータやローカルストレージに保存して取得する方法を採る
            // ここでは簡易的に直接window変数に設定する例を示す
            window.selectedEmployeeId = selectedEmployeeId;
            window.employeeName = employee.name;
            window.workItems = workItems;
          })
          .getWorkRecordPage();
        })
        .withFailureHandler(function(error) {
          showError("作業項目の取得に失敗しました: " + error);
        })
        .getWorkItems();
    }
    
    // 選択のリセット
    function resetSelection() {
      selectedEmployeeId = null;
      
      // 選択状態の更新
      document.querySelectorAll('.employee-item').forEach(function(item) {
        item.classList.remove('selected');
      });
      
      // 出退勤パネルの非表示
      document.getElementById('no-selection').classList.remove('hidden');
      document.getElementById('attendance-actions').classList.add('hidden');
      
      // ステータスメッセージをクリア
      clearStatusMessage();
    }
    
    // 成功メッセージの表示
    function showSuccess(message) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.className = 'success-message';
    }
    
    // エラーメッセージの表示
    function showError(message) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.className = 'error-message';
    }
    
    // ステータスメッセージのクリア
    function clearStatusMessage() {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = '';
      statusElement.className = '';
    }
    
    // パスワードモーダルの表示
    function showPasswordModal() {
      document.getElementById('password-error').classList.add('hidden');
      document.getElementById('admin-password').value = '';
      document.getElementById('password-modal').classList.remove('hidden');
    }
    
    // パスワードの検証
    function validateAdminPassword() {
      const password = document.getElementById('admin-password').value;
      
      if (password === adminPassword) {
        closeAllModals();
        // ローディングメッセージを表示
        showSuccess('管理画面に遷移します...');
        
        // 管理画面のURLを取得して遷移
        google.script.run
          .withSuccessHandler(function(url) {
            // 少し遅延させて遷移することでユーザーにフィードバックを与える
            setTimeout(function() {
              // 管理画面に直接遷移
              window.top.location.href = url + '?page=admin';
            }, 500);
          })
          .withFailureHandler(function(error) {
            console.error('管理画面URLの取得に失敗しました:', error);
            showError('管理画面への遷移に失敗しました: ' + error);
          })
          .getMainPageUrl();
      } else {
        document.getElementById('password-error').textContent = 'パスワードが正しくありません';
        document.getElementById('password-error').classList.remove('hidden');
      }
    }
    
    // すべてのモーダルを閉じる
    function closeAllModals() {
      document.getElementById('modal-container').classList.add('hidden');
      document.getElementById('password-modal').classList.add('hidden');
    }
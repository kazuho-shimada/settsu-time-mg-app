<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>勤怠管理システム</title>
  <script>
    // グローバル変数
    let employees = []; // 社員データ
    let selectedEmployeeId = null; // 選択中の社員ID
    let attendanceStatusCache = {}; // 社員ごとの勤怠状況キャッシュ
    let isProcessing = false; // 出勤・退勤処理中かどうか
    let processingEmployeeId = null; // 処理中の社員ID
    
    // ページ読み込み完了時に実行される処理
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMの読み込みが完了しました - index.html');
      
      // 日時の更新
      updateDateTime();
      setInterval(updateDateTime, 1000);
      
      // 社員データを取得
      fetchEmployees();
    });
    
    // 日時の更新
    function updateDateTime() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      const dateTimeStr = now.toLocaleDateString('ja-JP', options);
      const dateTimeElement = document.getElementById('current-datetime');
      if (dateTimeElement) {
        dateTimeElement.textContent = dateTimeStr;
      }
    }
    
    // 社員データの取得
    function fetchEmployees() {
      console.log('社員データを取得中...');
      
      // デバッグ用のデータ
      const sampleData = [
        { id: '1', name: '山田太郎' },
        { id: '2', name: '鈴木花子' },
        { id: '3', name: '田中三郎' }
      ];
      
      // サーバーからデータを取得
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('社員データを取得しました:', data);
          
          // データが空の場合はサンプルデータを使用
          if (!data || data.length === 0) {
            console.log('データが空のためサンプルデータを使用します');
            employees = sampleData;
          } else {
            employees = data;
          }
          
          // 社員一覧を表示
          renderEmployeeList();
        })
        .withFailureHandler(function(error) {
          console.error('社員データの取得に失敗しました:', error);
          
          // エラー時はサンプルデータを使用
          employees = sampleData;
          renderEmployeeList();
        })
        .getEmployees();
    }
    
    // 社員一覧の表示
    function renderEmployeeList() {
      console.log('社員一覧を表示します。社員数:', employees.length);
      
      // 社員リスト要素を取得
      const employeeListElement = document.getElementById('employee-list');
      if (!employeeListElement) {
        console.error('employee-list要素が見つかりません');
        return;
      }
      
      // リストをクリア
      employeeListElement.innerHTML = '';
      
      // 社員データが空の場合
      if (!employees || employees.length === 0) {
        employeeListElement.innerHTML = '<div class="empty-message">社員データがありません</div>';
        return;
      }
      
      // 各社員の要素を作成
      let html = '';
      for (let i = 0; i < employees.length; i++) {
        const employee = employees[i];
        if (!employee || !employee.id || !employee.name) continue;
        
        const selectedClass = (employee.id === selectedEmployeeId) ? ' selected' : '';
        html += `<div class="employee-item${selectedClass}" data-id="${employee.id}" onclick="selectEmployee('${employee.id}')">${employee.name}</div>`;
      }
      
      // HTMLを設定
      employeeListElement.innerHTML = html;
    }
    
    // 社員の選択
    function selectEmployee(employeeId) {
      console.log('社員を選択します:', employeeId);
      
      // 出勤・退勤処理中は社員切り替えを無効化
      if (isProcessing) {
        showStatusMessage('出勤・退勤処理中は社員を切り替えられません', true);
        console.log('処理中のため社員切り替えをキャンセルしました');
        return;
      }
      
      // 選択した社員IDを保存
      selectedEmployeeId = employeeId;
      
      // 全ての社員要素からselectedクラスを削除
      const items = document.querySelectorAll('.employee-item');
      for (let i = 0; i < items.length; i++) {
        items[i].classList.remove('selected');
      }
      
      // 選択された社員にクラスを追加
      const selectedItem = document.querySelector(`.employee-item[data-id="${employeeId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
      
      // 選択した社員の情報を表示
      const employee = employees.find(emp => emp.id === employeeId);
      if (employee) {
        // 社員名を表示
        document.getElementById('selected-employee-name').textContent = employee.name;
        
        // パネルの表示切替
        document.getElementById('no-selection').classList.add('hidden');
        document.getElementById('attendance-actions').classList.remove('hidden');
        
        // 勤怠状況を表示
        // キャッシュがあればそれを使用、なければ新規取得
        if (attendanceStatusCache[employeeId]) {
          console.log('キャッシュから勤怠状況を表示:', employeeId);
          updateAttendanceUI(attendanceStatusCache[employeeId]);
        } else {
          console.log('新規に勤怠状況を取得:', employeeId);
          fetchAttendanceStatus(employeeId);
        }
      }
    }
    
    // 勤怠状況を取得して表示
    function fetchAttendanceStatus(employeeId) {
      // 読み込み中の表示
      document.getElementById('status-text').textContent = '読み込み中...';
      document.getElementById('history-container').innerHTML = '<div class="loading-message">記録を読み込み中...</div>';
      
      // ボタンを無効化
      document.getElementById('check-in-btn').disabled = true;
      document.getElementById('check-out-btn').disabled = true;
      
      // サーバーから勤怠状況を取得
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // キャッシュに保存
            attendanceStatusCache[employeeId] = result.data;
            console.log('勤怠状況をキャッシュに保存:', employeeId);
            
            // UIを更新
            updateAttendanceUI(result.data);
          } else {
            showStatusMessage(result.message, true);
            document.getElementById('status-text').textContent = '取得失敗';
            document.getElementById('history-container').innerHTML = '<div class="no-history">勤怠記録を取得できませんでした</div>';
          }
        })
        .withFailureHandler(function(error) {
          showStatusMessage('勤怠状況の取得に失敗しました: ' + error, true);
          document.getElementById('status-text').textContent = 'エラー';
          document.getElementById('history-container').innerHTML = '<div class="no-history">エラーが発生しました</div>';
        })
        .getAttendanceStatus(employeeId);
    }
    
    // 勤怠状況のUIを更新
    function updateAttendanceUI(data) {
      console.log('勤怠状況を更新します:', data);
      
      if (!data) {
        console.error('勤怠状況データが空です');
        return;
      }
      
      // デバッグ用に勤怠状況を詳細表示
      console.log('出勤可能状態:', data.canCheckIn);
      console.log('退勤可能状態:', data.canCheckOut);
      
      // 本日の状況を表示
      const statusText = document.getElementById('status-text');
      if (!statusText) {
        console.error('status-text要素が見つかりません');
        return;
      }
      
      if (data.canCheckIn) {
        statusText.textContent = '未出勤';
        statusText.style.color = '#dc3545';
      } else if (data.canCheckOut) {
        statusText.textContent = '出勤中';
        statusText.style.color = '#28a745';
      } else {
        statusText.textContent = '退勤済み';
        statusText.style.color = '#6c757d';
      }
      
      // ボタンの有効/無効を設定
      const checkInBtn = document.getElementById('check-in-btn');
      const checkOutBtn = document.getElementById('check-out-btn');
      
      // デバッグ用にボタンの状態を表示
      console.log('出勤ボタン状態:', checkInBtn ? checkInBtn.disabled : '存在しません');
      console.log('退勤ボタン状態:', checkOutBtn ? checkOutBtn.disabled : '存在しません');
      
      // デバッグ中は退勤ボタンを強制的に有効化
      if (checkInBtn) checkInBtn.disabled = !data.canCheckIn;
      if (checkOutBtn) {
        console.log('退勤ボタンを有効化します');
        checkOutBtn.disabled = false; // 強制的に有効化
      }
      
      // 勤怠履歴を表示
      renderAttendanceHistory(data.history);
    }
    
    // 勤怠履歴を表示
    function renderAttendanceHistory(history) {
      const historyContainer = document.getElementById('history-container');
      
      if (!history || history.length === 0) {
        historyContainer.innerHTML = '<div class="no-history">直近の勤怠記録がありません</div>';
        return;
      }
      
      let html = '';
      for (let i = 0; i < history.length; i++) {
        const record = history[i];
        
        // 無効な記録はスキップ
        if (!record || !record.date) {
          continue;
        }
        
        html += `
          <div class="history-item">
            <div class="history-date">${record.date}</div>
            <div class="history-time">
              <div>出勤: ${record.checkInTime || '記録なし'}</div>
              <div>退勤: ${record.checkOutTime || '記録なし'}</div>
            </div>
          </div>
        `;
      }
      
      historyContainer.innerHTML = html;
    }
    
    // ステータスメッセージを表示
    function showStatusMessage(message, isError = false) {
      const statusElement = document.getElementById('status-message');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = isError ? 'error' : 'success';
        
        // 3秒後にメッセージを消す
        setTimeout(function() {
          statusElement.textContent = '';
          statusElement.className = '';
        }, 3000);
      }
    }
    
    // 出勤処理
    function handleCheckIn() {
      if (!selectedEmployeeId) {
        showStatusMessage('社員が選択されていません', true);
        return;
      }
      
      // 処理中フラグを設定
      isProcessing = true;
      processingEmployeeId = selectedEmployeeId;
      console.log('出勤処理開始 - 処理中社員ID:', processingEmployeeId);
      
      // ボタンを無効化
      const checkInBtn = document.getElementById('check-in-btn');
      const checkOutBtn = document.getElementById('check-out-btn');
      if (checkInBtn) checkInBtn.disabled = true;
      if (checkOutBtn) checkOutBtn.disabled = true;
      
      showStatusMessage('出勤処理中...');
      
      // サーバーに出勤処理をリクエスト
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatusMessage(result.message);
            console.log('出勤処理成功:', result);
            
            // 勤怠状況を更新
            if (result.data && result.data.status) {
              // 保存しておいた処理中社員IDを使用してキャッシュを更新
              attendanceStatusCache[processingEmployeeId] = result.data.status;
              console.log('出勤処理後にキャッシュを更新:', processingEmployeeId);
              
              // 現在表示中の社員が処理した社員と同じ場合のみ表示を更新
              if (selectedEmployeeId === processingEmployeeId) {
                updateAttendanceUI(result.data.status);
              } else {
                console.log('処理中に社員が切り替わったため、UI更新をスキップしました');
              }
            } else {
              // 状況が返ってこない場合は再取得
              if (selectedEmployeeId === processingEmployeeId) {
                fetchAttendanceStatus(selectedEmployeeId);
              }
            }
            
            // 処理中フラグをリセット
            isProcessing = false;
            console.log('出勤処理完了 - 処理中フラグをリセット');
          } else {
            showStatusMessage(result.message, true);
            console.error('出勤処理失敗:', result);
            
            // ボタンを再有効化
            if (checkInBtn) checkInBtn.disabled = false;
            if (checkOutBtn) checkOutBtn.disabled = false;
            
            // 処理中フラグをリセット
            isProcessing = false;
            console.log('出勤処理失敗 - 処理中フラグをリセット');
          }
        })
        .withFailureHandler(function(error) {
          showStatusMessage('エラーが発生しました: ' + error, true);
          console.error('出勤処理エラー:', error);
          
          // ボタンを再有効化
          if (checkInBtn) checkInBtn.disabled = false;
          if (checkOutBtn) checkOutBtn.disabled = false;
          
          // 処理中フラグをリセット
          isProcessing = false;
          console.log('出勤処理エラー - 処理中フラグをリセット');
        })
        .checkIn(selectedEmployeeId);
    }
    
    // 退勤処理
    function handleCheckOut() {
      console.log('退勤処理関数が呼び出されました');
      if (!selectedEmployeeId) {
        showStatusMessage('社員が選択されていません', true);
        return;
      }
      
      // ボタンを無効化
      const checkInBtn = document.getElementById('check-in-btn');
      const checkOutBtn = document.getElementById('check-out-btn');
      if (checkInBtn) checkInBtn.disabled = true;
      if (checkOutBtn) checkOutBtn.disabled = true;
      
      showStatusMessage('退勤処理中...');
      
      // サーバーに退勤処理をリクエスト
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatusMessage(result.message);
            console.log('退勤処理成功:', result);
            
            // 勤怠状況を更新
            console.log('退勤処理結果:', result);
            
            // 勤怠状況を強制的に再取得して表示する
            console.log('退勤処理後に勤怠状況を再取得します');
            
            // ボタンを再有効化
            if (checkInBtn) checkInBtn.disabled = false;
            if (checkOutBtn) checkOutBtn.disabled = false;
            
            // キャッシュをクリアして強制的に再取得
            delete attendanceStatusCache[selectedEmployeeId];
            
            // 少し遅延させて勤怠状況を再取得
            setTimeout(function() {
              console.log('遅延後に勤怠状況を再取得します');
              fetchAttendanceStatus(selectedEmployeeId);
            }, 1000); // 遅延を少し長くしてみる
          } else {
            showStatusMessage(result.message, true);
            console.error('退勤処理失敗:', result);
            
            // ボタンを再有効化
            if (checkInBtn) checkInBtn.disabled = false;
            if (checkOutBtn) checkOutBtn.disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          showStatusMessage('エラーが発生しました: ' + error, true);
          console.error('退勤処理エラー:', error);
          
          // ボタンを再有効化
          if (checkInBtn) checkInBtn.disabled = false;
          if (checkOutBtn) checkOutBtn.disabled = false;
        })
        .checkOut(selectedEmployeeId);
    }
    // テスト用の退勤処理関数
    function testCheckOut() {
      console.log('テスト退勤処理が呼び出されました');
      
      if (!selectedEmployeeId) {
        alert('社員が選択されていません');
        return;
      }
      
      // 選択中の社員IDを表示
      alert('退勤処理を開始します\n社員ID: ' + selectedEmployeeId);
      
      // ボタンを無効化
      document.getElementById('check-in-btn').disabled = true;
      document.getElementById('check-out-btn').disabled = true;
      
      // ステータスメッセージを表示
      showStatusMessage('退勤処理中...');
      
      // サーバーに直接退勤処理をリクエスト
      google.script.run
        .withSuccessHandler(function(result) {
          // 結果をアラートで表示
          alert('退勤処理結果:\n' + JSON.stringify(result));
          
          // ボタンを再有効化
          document.getElementById('check-in-btn').disabled = false;
          document.getElementById('check-out-btn').disabled = false;
          
          // 成功時は勤怠状況を再取得
          if (result && result.success) {
            showStatusMessage('退勤処理が完了しました');
            fetchAttendanceStatus(selectedEmployeeId);
          } else {
            showStatusMessage(result && result.message ? result.message : '退勤処理に失敗しました', true);
          }
        })
        .withFailureHandler(function(error) {
          // エラーをアラートで表示
          alert('退勤処理エラー:\n' + error);
          
          // ボタンを再有効化
          document.getElementById('check-in-btn').disabled = false;
          document.getElementById('check-out-btn').disabled = false;
          
          // エラーメッセージを表示
          showStatusMessage('退勤処理中にエラーが発生しました: ' + error, true);
        })
        .checkOut(selectedEmployeeId);
    }
  </script>
  <?!= include('css'); ?>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>勤怠管理システム</h1>
      </div>
      <div class="header-right">
        <div id="current-datetime"></div>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=admin" target="_top" id="admin-link" class="admin-button">管理画面</a>
      </div>
    </header>
    
    <div class="main-content">
      <div class="employee-list-container">
        <h2>社員一覧</h2>
        <div class="employee-list" id="employee-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
          <!-- 社員一覧がJSで動的に生成されます -->
          <div class="loading-message">データ読み込み中...</div>
        </div>
      </div>
      
      <div class="attendance-panel">
        <div id="no-selection">
          <p>左の一覧から社員を選択してください</p>
        </div>
        
        <div id="attendance-actions" class="hidden">
          <h2 id="selected-employee-name"></h2>
          
          <!-- 勤怠状況表示エリア -->
          <div class="attendance-status" style="display: none;">
            <div id="today-status"><span id="status-text">未出勤</span></div>
          </div>
          
          <div class="action-buttons">
            <button id="check-in-btn" class="btn check-in" onclick="handleCheckIn()">出勤</button>
            <button id="check-out-btn" class="btn check-out" onclick="handleCheckOut()">退勤</button>
          </div>
          
          <div class="status-container">
            <div id="status-message"></div>
          </div>
          
          <!-- 勤怠履歴表示エリア -->
          <div class="attendance-history">
            <h3>直近の勤怠記録</h3>
            <div id="history-container">
              <div class="loading-message">記録を読み込み中...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <footer>
      <p>© 2025 勤怠管理システム</p>
    </footer>
  </div>
  
  <!-- モーダルダイアログ用のコンテナ -->
  <div id="modal-container" class="modal-container hidden">
    <div class="modal-content">
      <div id="modal-header">
        <h3 id="modal-title"></h3>
        <span class="close-modal">&times;</span>
      </div>
      <div id="modal-body"></div>
      <div id="modal-footer"></div>
    </div>
  </div>
  
  <!-- パスワード入力モーダル -->
  <div id="password-modal" class="modal-container hidden">
    <div class="modal-content">
      <div id="password-modal-header">
        <h3>管理者認証</h3>
        <span class="close-modal" id="close-password">&times;</span>
      </div>
      <div id="password-modal-body">
        <p>管理画面にアクセスするためのパスワードを入力してください：</p>
        <input type="password" id="admin-password" class="full-width">
        <div id="password-error" class="error-message hidden"></div>
      </div>
      <div id="password-modal-footer">
        <button id="cancel-password" class="btn secondary">キャンセル</button>
        <button id="submit-password" class="btn primary">確認</button>
      </div>
    </div>
  </div>
</body>
</html>
